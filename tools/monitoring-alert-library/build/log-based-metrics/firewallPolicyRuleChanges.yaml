#@ load("/alert.lib.star", "build_alert")
#@ load("/alert.lib.yaml", "generate_notification_channels")
#@ load("@ytt:template", "template")
#@ alert = build_alert("firewallPolicyRuleChanges")

#@ if alert.to_generate():
description:  "Network Firewall Policy Rule Changes"
bucketName: #@ alert.log_bucket_name()
filter: >-
  resource.labels.method:"compute.networkFirewallPolicies" AND
  (
    protoPayload.methodName:"compute.networkFirewallPolicies.addRule" OR
    protoPayload.methodName:"compute.networkFirewallPolicies.removeRule" OR
    protoPayload.methodName:"compute.networkFirewallPolicies.patchRule"
  )
metricDescriptor:
  metricKind: "DELTA"
  valueType: "INT64"
  unit: "1"
  labels:
    - key: "principal"
      description: "principal"
      valueType: STRING
    - key: "method_name"
      description: "method_name"
      valueType: STRING
labelExtractors:
  principal: "EXTRACT(protoPayload.authenticationInfo.principalEmail)"
  method_name: "EXTRACT(protoPayload.methodName)"
#@ end
