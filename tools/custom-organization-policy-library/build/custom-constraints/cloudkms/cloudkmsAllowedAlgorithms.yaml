#@ load("/constraints.lib.star", "build_constraint")
#@ constraint = build_constraint("cloudkmsAllowedAlgorithms")

#@ def condition(algorithms):
#@   prefix = ""
#@   if "GOOGLE_SYMMETRIC_ENCRYPTION" in algorithms:
#@     prefix = "has(resource.versionTemplate.algorithm) && "
#@   end
#@   lines = [prefix + "resource.versionTemplate.algorithm in ["]
#@   for i in range(len(algorithms)):
#@     line = "  '" + algorithms[i] + "'"
#@     if i < len(algorithms) - 1:
#@       line += ","
#@     end
#@     lines.append(line)
#@   end
#@   lines.append("] == false")
#@   return "\n".join(lines)
#@ end

#@ if constraint.to_generate():
name: #@ constraint.constraint_name()
resourceTypes:
- cloudkms.googleapis.com/CryptoKey
methodTypes:
- CREATE
- UPDATE
condition: #@  condition(constraint.params().algorithms)
actionType: DENY
displayName: Require Cloud KMS keys algorithm to be configured correctly
description: Ensure the algorithm for Cloud KMS keys is configured correctly
#@ end