#@ load("/constraints.lib.star", "build_constraint")
#@ constraint = build_constraint("iamDisableProjectServiceAccountImpersonationRoles")

#@ def exceptions(domains):
#@   quoted_domains = ["'%s'" % d for d in domains]
#@   joined_domains = ", ".join(quoted_domains)
#@   return "!MemberSubjectMatches(member, [%s])" % joined_domains
#@ end

#@ def condition(principal_exceptions):
#@   lines = [
#@     "resource.bindings.exists(binding,",
#@     "  binding.members.exists(member,",
#@     "    {exceptions} &&",
#@     "    MemberSubjectStartsWith(member, ['user:', 'group:'])",
#@     "  ) &&",
#@     "  (",
#@     "    RoleNameMatches(binding.role, ['roles/iam.serviceAccountUser']) ||",
#@     "    RoleNameMatches(binding.role, ['roles/iam.serviceAccountTokenCreator'])",
#@     "  )",
#@     ")"
#@   ]
#@   
#@   full_string = "\n".join(lines)
#@   return full_string.format(exceptions=exceptions(principal_exceptions))
#@ end

#@ if constraint.to_generate():
name: #@ constraint.constraint_name()
resourceTypes:
- iam.googleapis.com/AllowPolicy
methodTypes:
- CREATE
- UPDATE
condition: #@ condition(constraint.params().exceptions)
actionType: DENY
displayName:  Deny assignement of the service account user or service account token creator roles to users
description: >-
  Ensure that IAM Users are not assigned the service account user or service account token creator roles (requires usage of IAM Condition and tags to ensure the constraint is not applied on allowed service accounts)
#@ end