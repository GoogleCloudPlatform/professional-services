<!--
 Copyright 2025 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<div class="lg:container lg:mx-auto">
  <div class="home-margin grid grid-cols-1">
    <!-- Video Homepage -->
    <ng-container *ngIf="isLoading; else videoOrGallery">
      <div class="video-container">
        <div class="w-full h-full flex justify-center items-center">
          <mat-progress-spinner
            color="primary"
            mode="indeterminate"
          ></mat-progress-spinner>
        </div>
      </div>
    </ng-container>

    <ng-template #videoOrGallery>
      <ng-container *ngIf="activeVideoJob$ | async as job">
        <div
          *ngIf="job.status === JobStatus.PROCESSING"
          class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black bg-opacity-70 rounded-xl"
        >
          <mat-progress-spinner
            color="primary"
            mode="indeterminate"
            [diameter]="50"
          ></mat-progress-spinner>
          <p class="!mt-6 text-white text-lg">
            Your video is being generated...
          </p>
          <p class="text-gray-400 text-sm">
            This may take a few minutes. You can safely navigate away.
          </p>
        </div>

        <div
          *ngIf="job.status === JobStatus.FAILED && showErrorOverlay"
          class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black bg-opacity-70 rounded-xl text-center p-4"
        >
          <mat-icon class="text-red-500 !w-16 !h-16 !text-6xl"
            >error_outline</mat-icon
          >
          <p class="mt-4 text-white text-lg">Video Generation Failed</p>
          <p class="text-gray-400 text-sm max-w-md">
            {{ job.errorMessage || job.error_message }}
          </p>
          <button
            mat-raised-button
            color="primary"
            (click)="closeErrorOverlay()"
            class="mt-4"
          >
            Close
          </button>
        </div>

        <!-- Video Gallery -->
        <app-media-lightbox
          *ngIf="job.status === JobStatus.COMPLETED"
          [mediaItem]="job"
          [initialIndex]="0"
          [showSeeMoreInfoButton]="true"
          (extendWithAiClicked)="handleExtendWithAi($event)"
          (concatenateClicked)="handleConcatenate($event)"
          style="max-height: 60vh"
        ></app-media-lightbox>
      </ng-container>

      <ng-container
        *ngIf="(activeVideoJob$ | async)?.status !== JobStatus.COMPLETED"
      >
        <div class="video-container">
          <video
            class="w-full rounded-xl"
            oncanplay="this.play()"
            onloadedmetadata="this.muted = true"
            muted
            playsinline
            loop
            autoplay
          >
            <source
              src="assets/videos/generate-video-homepage-video.mp4"
              type="video/mp4"
            />
          </video>
          <div
            class="top-[40%] md:top-[20%] lg:top-[30%] xl:top-[40%] absolute w-full text-center justify-center text-3xl md:text-6xl font-bold bg-gradient-to-r from-blue-500 via-violet-500 to-red-400 bg-clip-text text-transparent"
          >
            Generate Video Ads
          </div>
        </div>
      </ng-container>
    </ng-template>

    <!-- Control Options -->
    <div
      class="control-options inline-flex justify-center items-start grid grid-cols-2 md:grid-cols-3 lg:flex gap-4 mt-8 place-items-center"
    >
      <div
        matTooltip="Select Aspect Ratio"
        class="cursor-pointer w-24 inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          [matMenuTriggerFor]="aspectRatioMenu"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon>aspect_ratio</mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          {{ selectedAspectRatio }}
        </div>
        <mat-menu #aspectRatioMenu="matMenu">
          <button
            *ngFor="let ratio of aspectRatioOptions"
            [disabled]="ratio.disabled"
            mat-menu-item
            [ngClass]="{
              'menu-item-selected': searchRequest.aspectRatio === ratio.value,
            }"
            (click)="selectAspectRatio(ratio)"
          >
            <span>{{ ratio.viewValue }}</span>
          </button>
        </mat-menu>
      </div>
      <div
        matTooltip="Select Model"
        class="cursor-pointer w-28 inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          [matMenuTriggerFor]="modelMenu"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon svgIcon="content-type-icon"></mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          {{ selectedGenerationModel }}
        </div>
        <mat-menu #modelMenu="matMenu">
          <button
            *ngFor="let model of generationModels"
            mat-menu-item
            [ngClass]="{
              'menu-item-selected':
                searchRequest.generationModel === model.value,
            }"
            (click)="selectModel(model)"
          >
            <span>{{ model.viewValue }}</span>
          </button>
        </mat-menu>
      </div>

      <div
        matTooltip="Select Style"
        class="cursor-pointer w-24 inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          [matMenuTriggerFor]="videoStylingMenu"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon>style</mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          {{ searchRequest.style ? searchRequest.style : 'Style' }}
        </div>
        <mat-menu #videoStylingMenu="matMenu">
          <button
            *ngFor="let style of videoStyles"
            mat-menu-item
            [ngClass]="{'menu-item-selected': searchRequest.style === style}"
            (click)="selectVideoStyle(style)"
          >
            <span>{{ style }}</span>
          </button>
        </mat-menu>
      </div>

      <div
        matTooltip="Select Color & Tone"
        class="cursor-pointer w-24 inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          [matMenuTriggerFor]="colorMenu"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon>palette</mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          {{
            searchRequest.colorAndTone
              ? searchRequest.colorAndTone
              : 'Color & Tone'
          }}
        </div>
        <mat-menu #colorMenu="matMenu">
          <button
            *ngFor="let color of colorsAndTones"
            mat-menu-item
            [ngClass]="{
              'menu-item-selected': searchRequest.colorAndTone === color,
            }"
            (click)="selectColor(color)"
          >
            <span>{{ color }}</span>
          </button>
        </mat-menu>
      </div>
      <div
        matTooltip="Select Lighting"
        class="cursor-pointer w-24 inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          [matMenuTriggerFor]="lightingMenu"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon svgIcon="lighting-icon"></mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          {{ searchRequest.lighting ? searchRequest.lighting : 'Lighting' }}
        </div>
        <mat-menu #lightingMenu="matMenu">
          <button
            *ngFor="let light of lightings"
            mat-menu-item
            [ngClass]="{'menu-item-selected': searchRequest.lighting === light}"
            (click)="selectLighting(light)"
          >
            <span>{{ light }}</span>
          </button>
        </mat-menu>
      </div>

      <div
        matTooltip="Select Number of Videos"
        class="cursor-pointer w-24 inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          [matMenuTriggerFor]="numVideosMenu"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon svgIcon="number-of-images-icon" color="primary"></mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          {{ searchRequest.numberOfMedia }}
          Video(s)
        </div>
        <mat-menu #numVideosMenu="matMenu">
          <button
            *ngFor="let num of numberOfVideosOptions"
            mat-menu-item
            [ngClass]="{
              'menu-item-selected': searchRequest.numberOfMedia === num,
            }"
            (click)="selectNumberOfVideos(num)"
          >
            <span>{{ num }}</span>
          </button>
        </mat-menu>
      </div>
      <div
        matTooltip="Select Video Duration"
        class="cursor-pointer w-24 inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          [matMenuTriggerFor]="durationMenu"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon>timer</mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          {{ searchRequest.durationSeconds }}s
        </div>
        <mat-menu #durationMenu="matMenu">
          <button
            *ngFor="let duration of durationOptions"
            mat-menu-item
            [ngClass]="{
              'menu-item-selected': searchRequest.durationSeconds === duration,
            }"
            (click)="selectDuration(duration)"
          >
            <span>{{ duration }}s</span>
          </button>
        </mat-menu>
      </div>
      <div
        matTooltip="Select Composition"
        class="cursor-pointer w-24 rounded-lg inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          [matMenuTriggerFor]="compositionMenu"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon>movie_edit</mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          {{
            searchRequest.composition
              ? searchRequest.composition
              : 'Composition'
          }}
        </div>
        <mat-menu #compositionMenu="matMenu">
          <button
            *ngFor="let comp of compositions"
            mat-menu-item
            [ngClass]="{
              'menu-item-selected': searchRequest.composition === comp,
            }"
            (click)="selectComposition(comp)"
          >
            <span>{{ comp }}</span>
          </button>
        </mat-menu>
      </div>

      <div
        [matTooltip]="
          isAudioGenerationDisabled
            ? 'Audio not supported for this model'
            : 'Toggle Audio Generation'
        "
        class="cursor-pointer w-24 inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          (click)="toggleAudio()"
          [disabled]="isAudioGenerationDisabled"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon>{{
            searchRequest.generateAudio ? 'volume_up' : 'volume_off'
          }}</mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          Audio {{ searchRequest.generateAudio ? 'On' : 'Off' }}
        </div>
      </div>

      <div
        matTooltip="Select Negative Phrases"
        class="cursor-pointer w-36 inline-flex flex-col justify-start items-center"
      >
        <button
          mat-fab
          [matMenuTriggerFor]="negativePhrasesMenu"
          class="!w-16 !h-16 !shadow-none text-center justify-center text-stone-300 text-2xl"
        >
          <mat-icon>block</mat-icon>
        </button>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          Negative Phrases ({{ negativePhrases.length }})
        </div>
        <mat-menu #negativePhrasesMenu="matMenu" class="negative-phrases-menu">
          <div class="p-2" (click)="$event.stopPropagation()">
            <mat-form-field class="w-full">
              <mat-label>Things to avoid...</mat-label>
              <mat-chip-grid #chipGrid aria-label="Enter negative phrases">
                <mat-chip-row
                  *ngFor="let phrase of negativePhrases"
                  (removed)="removeNegativePhrase(phrase)"
                  matTooltipPosition="below"
                  class="negative-prompt-chips"
                >
                  {{ phrase }}
                  <button matChipRemove [matTooltip]="'Remove ' + phrase">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip-row>
              </mat-chip-grid>
              <input
                placeholder="New phrase..."
                [matChipInputFor]="chipGrid"
                (matChipInputTokenEnd)="addNegativePhrase($event)"
              />
            </mat-form-field>
          </div>
        </mat-menu>
      </div>
      <div
        matTooltip="Enable Brand Guidelines"
        class="cursor-pointer w-32 inline-flex flex-col justify-start items-center"
      >
        <mat-slide-toggle
          [(ngModel)]="searchRequest.useBrandGuidelines"
          (ngModelChange)="saveState()"
          class="!w-16 !h-16 !shadow-none text-center !flex justify-center items-center text-stone-300"
        >
        </mat-slide-toggle>
        <div class="text-center justify-center text-neutral-200 text-base mt-2">
          Brand Guidelines
        </div>
      </div>

      <!-- <div
        matTooltip="Replay Last Execution"
        class="cursor-pointer w-12 h-12 bg-black rounded-3xl flex justify-center items-center gap-2.5 overflow-hidden mt-4"
      >
        <button
          mat-fab
          class="!w-16 !h-16 !shadow-none text-center justify-center text-white text-xl"
        >
          <mat-icon>replay</mat-icon>
        </button>
      </div> -->
    </div>

    <!-- Prompt Generator -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 my-5">
      <!-- Prompt Section -->
      <div class="lg:col-span-2 flex flex-col justify-start items-start gap-4">
        <div
          class="justify-center text-neutral-200 text-base font-bold leading-7"
        >
          Prompt:
        </div>
        <textarea
          [disabled]="isConcatenateMode"
          id="promptId"
          [(ngModel)]="searchRequest.prompt"
          class="self-stretch w-full h-48 p-4 bg-transparent md:bg-zinc-700 rounded-2xl text-stone-300 text-base font-normal leading-7 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
          placeholder="Enter your prompt here..."
          (ngModelChange)="service.videoPrompt = $event; saveState()"
        ></textarea>
        <div
          class="inline-flex justify-between items-center grid grid-cols-1 lg:flex gap-4"
        >
          <div class="flex justify-start items-center gap-4">
            <!-- <button mat-raised-button color="primary" (click)="getRandomPrompt()" [disabled]="isLoading">
              <mat-icon>shuffle</mat-icon>
              Random
            </button> -->
            <button
              mat-raised-button
              color="primary"
              (click)="rewritePrompt()"
              [disabled]="isLoading"
            >
              <mat-icon>drive_file_rename_outline</mat-icon>
              Rewrite
            </button>
            <button
              mat-raised-button
              class="!bg-white"
              (click)="searchTerm()"
              [disabled]="isLoading"
            >
              <mat-icon svgIcon="gemini-spark-icon"></mat-icon>
              <span
                class="font-bold bg-gradient-to-r from-blue-500 via-violet-500 to-red-400 bg-clip-text text-transparent"
              >
                @if (isExtensionMode) {
                  Extend with AI
                } @else if (isConcatenateMode) {
                  Concatenate
                } @else {
                  Generate
                }
              </span>
            </button>
          </div>
          <button
            mat-stroked-button
            class="!text-white"
            (click)="resetAllFilters()"
            [disabled]="isLoading"
          >
            Clear All
          </button>
        </div>
      </div>

      <div class="lg:col-span-2 grid grid-cols-3 gap-4 text-center">
        <div
          class="drop-zone"
          (click)="openImageSelector(1)"
          (dragover)="$event.preventDefault()"
          (drop)="onDrop($event, 1)"
        >
          <div *ngIf="!image1Preview" class="drop-zone-placeholder">
            <mat-icon>add_photo_alternate</mat-icon>
            <span>Add a starting frame (image) or a video to extend</span>
          </div>
          <div *ngIf="image1Preview" class="image-preview-container">
            <img [src]="image1Preview" alt="Dropped Image 1" />
            <button
              (click)="clearImage(1, $event)"
              class="clear-button"
              mat-icon-button
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
        <div
          class="drop-zone"
          (click)="openImageSelector(2)"
          (dragover)="$event.preventDefault()"
          (drop)="onDrop($event, 2)"
        >
          <div *ngIf="!image2Preview" class="drop-zone-placeholder">
            <mat-icon>add_photo_alternate</mat-icon>
            <span>Add an ending frame (image) or a video to concatenate</span>
          </div>
          <div *ngIf="image2Preview" class="image-preview-container">
            <img [src]="image2Preview" alt="Dropped Image 2" />
            <button
              (click)="clearImage(2, $event)"
              class="clear-button"
              mat-icon-button
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <div
          class="drop-zone relative flex flex-col p-2"
          [class.disabled]="referenceImages.length >= 3"
          (click)="
            referenceImages.length < 3 && openImageSelectorForReference()
          "
          (dragover)="$event.preventDefault()"
          (drop)="referenceImages.length < 3 && onReferenceImageDrop($event)"
        >
          <div
            *ngIf="referenceImages.length === 0"
            class="drop-zone-placeholder m-auto"
          >
            <mat-icon>collections</mat-icon>
            <span>Add Reference Images</span>
            <span>(Max 3)</span>
          </div>

          <div
            *ngIf="referenceImages.length > 0"
            class="w-full h-full flex flex-col gap-2"
          >
            <div class="global-reference-toggle">
              <mat-slide-toggle
                [checked]="referenceImagesType === 'STYLE'"
                (change)="
                  referenceImagesType = $event.checked ? 'STYLE' : 'ASSET'
                "
                (click)="$event.stopPropagation()"
              >
                <span class="text-white text-sm font-medium"
                  >Use all as STYLE</span
                >
              </mat-slide-toggle>
            </div>

            <div class="reference-previews-container">
              <div
                *ngFor="let refImage of referenceImages; let i = index"
                class="image-preview-container small"
              >
                <img
                  [src]="refImage.previewUrl"
                  [alt]="'Reference Image ' + (i + 1)"
                />
                <button
                  (click)="clearReferenceImage(i, $event)"
                  class="clear-button small"
                  mat-icon-button
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>

            <div
              *ngIf="referenceImages.length >= 3"
              class="drop-zone-limit-reached"
            >
              <p>Maximum of 3 reference images reached.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
